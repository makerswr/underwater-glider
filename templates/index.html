<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Underwater Glider Control System</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f5f7fa; color:#333; overflow-x:hidden; }
    .container { display:grid; gap:20px; padding:20px; height:100vh; box-sizing:border-box; overflow:hidden;
      grid-template-columns: 1fr;
      grid-template-areas:
        "camera"
        "sensor"
        "glider"
        "control"
        "map";
    }
    @media (min-width:1100px){
      .container {
        grid-template-columns: 1fr 1fr 1.2fr;
        grid-template-rows: minmax(0,1fr) minmax(0,1fr);
        grid-template-areas:
          "camera camera map"
          "sensor control map";
      }
    }
    @media (min-width:1400px){
      .container {
        grid-template-columns: 1fr 1fr 1.2fr;
        grid-template-rows: minmax(0,1fr) minmax(0,1fr);
        grid-template-areas:
          "camera sensor map"
          "glider control map";
      }
    }
    .panel { background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.1); padding:20px; border:1px solid #e1e8ed; display:flex; flex-direction:column; min-height:0; }
    .camera-panel { grid-area: camera; overflow:hidden; }
    .glider-panel { grid-area: glider; overflow:hidden; }
    .sensor-panel { grid-area: sensor; overflow:hidden; }
    .control-panel { grid-area: control; overflow:auto; }
    .map-panel { grid-area: map; overflow:hidden; }
    h2 { margin-top:0; color:#2c3e50; text-align:center; border-bottom:2px solid #3498db; padding-bottom:10px; position:sticky; top:0; background:#fff; z-index:1; }
    #glider-container, #map-container { flex:1; min-height:0; border-radius:8px; background:#fff; position:relative; overflow:hidden; border:1px solid #dee2e6; }
    #sensor-data { display:grid; grid-template-columns:1fr 1fr; gap:10px; flex:1; min-height:0; overflow:auto; max-height:none; }
    @media (max-width:700px){
      #sensor-data { grid-template-columns:1fr; }
    }
    .sensor-item { background:#3498db; color:#fff; padding:10px; border-radius:8px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.1); display:flex; flex-direction:column; justify-content:center; }
    .sensor-label { font-size:.9em; opacity:.9; margin-bottom:5px; }
    .sensor-value { font-size:1.2em; font-weight:bold; font-family:'Courier New', monospace; }
    .sensor-unit { font-size:.8em; opacity:.8; }
    #log-console { background:#2c3e50; color:#ecf0f1; padding:15px; border-radius:8px; flex:1; overflow-y:scroll; font-family:'Courier New', monospace; font-size:.9em; border:1px solid #34495e; min-height:200px; height:28vh; }
    #log-console p { margin:2px 0; }
    .control-group { display:flex; gap:10px; margin-bottom:20px; }
    .control-group input { flex-grow:1; padding:12px; border:2px solid #ddd; border-radius:6px; font-size:1em; transition:border-color .3s; }
    .control-group input:focus { outline:none; border-color:#3498db; }
    .control-group button, .test-btn { padding:12px 20px; background:#3498db; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:1em; transition:background-color .2s; }
    .control-group button:hover, .test-btn:hover { background:#2980b9; }
    .test-buttons { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
    .test-btn { padding:8px 16px; background:#e74c3c; }
    .test-btn:hover { background:#c0392b; }
    .status-indicator { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .status-connected { background:#27ae60; }
    .status-disconnected { background:#e74c3c; }
    .param-hint { font-size:.85em; color:#666; align-self:center; }
    /* Ïπ¥Î©îÎùº Ïª®ÌÖåÏù¥ÎÑà: 16:9 ÎπÑÏú® Ïú†ÏßÄ */
    #camera-container { flex:0 0 auto; aspect-ratio:16/9; width:100%; overflow:hidden; }
    #video-gallery { max-height:24vh; overflow:auto; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <!-- Ïπ¥Î©îÎùº Ìå®ÎÑê -->
    <div class="panel camera-panel">
      <h2><span class="status-indicator status-disconnected"></span>Live Camera Feed</h2>
      <div id="camera-container" style="border-radius:8px;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;padding:20px;">
        <div style="text-align:center;line-height:1.6;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
          <div style="font-size:2.5em;margin-bottom:15px;">üìπ</div>
          <div style="font-size:1.1em;margin-bottom:8px;">Camera Not Available</div>
          <div style="font-size:.9em;opacity:.8;">Glider Control System Active</div>
        </div>
      </div>
      <div class="test-buttons" style="margin-top:10px;">
        <button class="test-btn" onclick="startRecording()" style="background:#e74c3c;">Start Recording</button>
        <button class="test-btn" onclick="stopRecording()" style="background:#95a5a6;">Stop Recording</button>
        <button class="test-btn" onclick="refreshVideoList()" style="background:#27ae60;">Refresh Videos</button>
      </div>
      <div id="recording-info" style="font-size:.9em;color:#666;margin:4px 0 8px 0;">Recording: OFF</div>
      <div id="video-gallery" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-height:22vh;overflow:auto;align-items:start;">
        <div>
          <h3 style="margin:6px 0 8px 0;font-size:1em;color:#2c3e50;border-bottom:1px solid #e1e8ed;padding-bottom:4px;">Saved Videos</h3>
          <div id="saved-videos" style="display:flex;flex-direction:column;gap:6px;"></div>
        </div>
        <div>
          <h3 style="margin:6px 0 8px 0;font-size:1em;color:#2c3e50;border-bottom:1px solid #e1e8ed;padding-bottom:4px;">Player</h3>
          <video id="video-player" controls style="width:100%;border-radius:6px;background:#000;max-height:18vh;"></video>
        </div>
      </div>
    </div>

    <!-- 3D Í∏ÄÎùºÏù¥Îçî Ìå®ÎÑê -->
    <div class="panel glider-panel">
      <h2><span class="status-indicator status-connected"></span>3D Glider Visualization</h2>
      <div id="connection-info" style="margin-bottom:10px;font-size:.9em;color:#666;">
        <div>Arduino: <span id="arduino-status" class="status-indicator status-disconnected"></span><span id="arduino-text">Checking connection...</span></div>
        <div>Camera: <span id="camera-status" class="status-indicator status-disconnected"></span><span id="camera-text">Checking connection...</span></div>
        <div id="camera-device-info" style="font-size:.8em;color:#888;margin-top:5px;"></div>
      </div>
      <div id="glider-container"></div>
    </div>

    <!-- ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ìå®ÎÑê -->
    <div class="panel sensor-panel">
      <h2>MPU6050 Sensor Data</h2>
      <div id="sensor-data">
        <div class="sensor-item"><div class="sensor-label">Acceleration X</div><div class="sensor-value" id="acc-x">0.00</div><div class="sensor-unit">m/s¬≤</div></div>
        <div class="sensor-item"><div class="sensor-label">Acceleration Y</div><div class="sensor-value" id="acc-y">0.00</div><div class="sensor-unit">m/s¬≤</div></div>
        <div class="sensor-item"><div class="sensor-label">Acceleration Z</div><div class="sensor-value" id="acc-z">0.00</div><div class="sensor-unit">m/s¬≤</div></div>
        <div class="sensor-item"><div class="sensor-label">Gyroscope X</div><div class="sensor-value" id="gyro-x">0.00</div><div class="sensor-unit">¬∞/s</div></div>
        <div class="sensor-item"><div class="sensor-label">Gyroscope Y</div><div class="sensor-value" id="gyro-y">0.00</div><div class="sensor-unit">¬∞/s</div></div>
        <div class="sensor-item"><div class="sensor-label">Gyroscope Z</div><div class="sensor-value" id="gyro-z">0.00</div><div class="sensor-unit">¬∞/s</div></div>
        <div class="sensor-item"><div class="sensor-label">Temperature</div><div class="sensor-value" id="temperature">25.0</div><div class="sensor-unit">¬∞C</div></div>
        <div class="sensor-item"><div class="sensor-label">Pitch</div><div class="sensor-value" id="pitch">0.0</div><div class="sensor-unit">¬∞</div></div>
      </div>
    </div>

    <!-- Ï†úÏñ¥ Î∞è Î°úÍ∑∏ Ìå®ÎÑê -->
    <div class="panel control-panel">
      <h2>Control & Log</h2>
      <div class="test-buttons">
        <button class="test-btn" onclick="simulateMovement()">Start Simulation</button>
        <button class="test-btn" onclick="stopSimulation()">Stop Simulation</button>
        <button class="test-btn" onclick="resetGlider()">Reset Glider</button>
      </div>
      <div class="test-buttons">
        <button class="test-btn" onclick="reconnectDevices()" style="background:#27ae60;">Reconnect Devices</button>
        <button class="test-btn" onclick="scanPorts()" style="background:#f39c12;">Scan Ports</button>
      </div>
      <div class="test-buttons">
        <button class="test-btn" onclick="toggleWireframe()">Toggle Wireframe</button>
        <button class="test-btn" onclick="toggleAxes()">Toggle Axes</button>
      </div>
      <div class="test-buttons">
        <button class="test-btn" onclick="startPreMission()" style="background:#8e44ad;">Start Pre-Mission Route</button>
      </div>
      <!-- Mission Config -->
      <div class="test-buttons">
        <select id="mission-pattern">
          <option value="sawtooth_pitch">Sawtooth Pitch</option>
          <option value="pitch_only_test">Pitch Only Test</option>
          <option value="small_box_turn">Small Box Turn</option>
          <option value="custom_segments">Custom Segments</option>
        </select>
        <button class="test-btn" onclick="startMission()" style="background:#8e44ad;">Start Mission</button>
      </div>
      <!-- sawtooth & pitch_only_test -->
      <div id="params-sawtooth" class="test-buttons">
        <span class="param-hint">Pitch step (M1 ¬±steps)</span><input id="pitch-step" type="number" value="200" placeholder="pitch_step" />
        <span class="param-hint">Segment time (seconds)</span><input id="segment-time" type="number" value="2.0" step="0.1" placeholder="segment_time(s)" />
        <span class="param-hint">Start delay (seconds)</span><input id="start-delay" type="number" value="20.0" step="0.1" placeholder="start_delay(s)" />
        <span class="param-hint">Repeat (cycles)</span><input id="repeat" type="number" value="5" placeholder="repeat" />
      </div>
      <div id="params-pitch-test" class="test-buttons" style="display:none;">
        <span class="param-hint">Pitch step (M1 ¬±steps)</span><input id="pt-pitch-step" type="number" value="200" placeholder="pitch_step" />
        <span class="param-hint">Segment time (seconds)</span><input id="pt-segment-time" type="number" value="2.0" step="0.1" placeholder="segment_time(s)" />
        <span class="param-hint">Start delay (seconds)</span><input id="pt-start-delay" type="number" value="5.0" step="0.1" placeholder="start_delay(s)" />
      </div>
      <!-- small_box_turn -->
      <div id="params-small-box" class="test-buttons" style="display:none;">
        <span class="param-hint">Pitch step (M1 ¬±steps)</span><input id="sb-pitch-step" type="number" value="200" placeholder="pitch_step" />
        <span class="param-hint">Turn step (M2 +steps)</span><input id="sb-turn-step" type="number" value="200" placeholder="turn_step" />
        <span class="param-hint">Forward time (seconds)</span><input id="sb-seg-forward" type="number" value="2.0" step="0.1" placeholder="segment_time_forward(s)" />
        <span class="param-hint">Turn time (seconds)</span><input id="sb-seg-turn" type="number" value="1.0" step="0.1" placeholder="segment_time_turn(s)" />
        <span class="param-hint">Start delay (seconds)</span><input id="sb-start-delay" type="number" value="5.0" step="0.1" placeholder="start_delay(s)" />
        <span class="param-hint">Repeat (cycles)</span><input id="sb-repeat" type="number" value="4" placeholder="repeat" />
      </div>
      <!-- custom_segments -->
      <div id="params-custom" style="display:none; margin:10px 0;">
        <div class="test-buttons">
          <span class="param-hint">Start delay (seconds)</span><input id="custom-start-delay" type="number" value="5.0" step="0.1" placeholder="start_delay(s)" />
          <button class="test-btn" onclick="addCustomSegmentRow()">Add Segment</button>
        </div>
        <div style="max-height:150px; overflow:auto; border:1px solid #e1e8ed; border-radius:6px; padding:6px; background:#fafbfc;">
          <table id="custom-segments-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left;">
                <th style="padding:6px;">M1 steps (pitch)</th>
                <th style="padding:6px;">M2 steps (turn)</th>
                <th style="padding:6px;">Wait after (s)</th>
                <th style="padding:6px;">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="test-buttons">
        <select id="gps-path" onchange="changeGPSPath(this.value)">
          <option value="none">No GPS Demo</option>
          <option value="circle">Circular Path</option>
          <option value="straight">Straight Line</option>
          <option value="zigzag">Zigzag Pattern</option>
          <option value="spiral">Spiral Path</option>
        </select>
        <button class="test-btn" onclick="startGPSDemo()">Start GPS Demo</button>
        <button class="test-btn" onclick="stopGPSDemo()">Stop GPS Demo</button>
      </div>
      <div class="control-group">
        <input type="text" id="command-input" placeholder="Enter command (e.g., +2000, -r1)" />
        <button onclick="sendCommand()">Send</button>
      </div>
      <div id="log-console"><p>Waiting for logs...</p></div>
    </div>

    <!-- GPS ÏßÄÎèÑ Ìå®ÎÑê -->
    <div class="panel map-panel">
      <h2>GPS Tracking & Navigation</h2>
      <div id="gps-info" style="margin-bottom:10px;font-size:.8em;color:#666;display:grid;grid-template-columns:1fr 1fr;gap:5px;">
        <div>Lat: <span id="gps-lat">0.000000</span>¬∞</div>
        <div>Lon: <span id="gps-lon">0.000000</span>¬∞</div>
        <div>Speed: <span id="gps-speed">0.0</span> kn</div>
        <div>Hdg: <span id="gps-heading">0</span>¬∞</div>
      </div>
      <div id="map-container"></div>
    </div>
  </div>

  <script>
    // ===== Ï†ÑÏó≠ =====
    let scene, camera, renderer, glider, animationId;
    let isSimulating = false, simulationInterval;
    let wireframeMode = false, axesVisible = true;

    // ÏãúÍ∞ÑÍ∏∞Î∞ò Î≥¥Í∞Ñ
    const clock = new THREE.Clock();

    // Î™©Ìëú ÏøºÌÑ∞ÎãàÏñ∏Í≥º ÎßàÏßÄÎßâ DMP ÏàòÏã†ÏãúÍ∞Å
    let targetQuat = new THREE.Quaternion();
    let lastDmpAt = 0;

    const deg2rad = d => d * Math.PI / 180;

    // ÏßÄÎèÑ Í¥ÄÎ†®
    let map, gliderMarker, pathLayer;
    let currentGPSData = { lat: 37.5665, lon: 126.9780, speed: 0, heading: 0 };
    let gpsDemoActive = false, gpsDemoInterval, currentPath = [], pathIndex = 0;

    // ===== 3D Ï¥àÍ∏∞Ìôî =====
    function initGlider() {
      const container = document.getElementById('glider-container');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(3, 2, 3);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      scene.add(new THREE.AmbientLight(0x404040, 0.6));
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(10,10,5); dir.castShadow = true; scene.add(dir);

      createGlider();
      animate();
    }

    // Ïπ¥Î©îÎùº
    function initCamera() {
      const cameraContainer = document.getElementById('camera-container');
      const videoFeed = document.createElement('img');
      videoFeed.src = '/video_feed';
      videoFeed.style.width = '100%';
      videoFeed.style.height = '100%';
      videoFeed.style.objectFit = 'cover';
      videoFeed.style.borderRadius = '8px';
      videoFeed.onload = function() {
        cameraContainer.innerHTML = '';
        cameraContainer.appendChild(videoFeed);
        addLogMessage('Camera feed loaded successfully');
      };
      videoFeed.onerror = function() {
        cameraContainer.innerHTML = `
          <div style="text-align:center;line-height:1.6;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div style="font-size:2.5em;margin-bottom:15px;">üìπ</div>
            <div style="font-size:1.1em;margin-bottom:8px;">Camera Not Available</div>
            <div style="font-size:.9em;opacity:.8;">Glider Control System Active</div>
          </div>`;
        addLogMessage('Camera not available, showing placeholder');
      };
      cameraContainer.appendChild(videoFeed);
      addLogMessage('Camera feed initialization started');
    }

    // ÏßÄÎèÑ
    function initMap() {
      map = L.map('map-container').setView([37.5665, 126.9780], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(map);
      const gliderIcon = L.divIcon({ className:'glider-marker',
        html:'<div style="background:#e74c3c;width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px rgba(0,0,0,.5);"></div>',
        iconSize:[20,20], iconAnchor:[10,10]});
      gliderMarker = L.marker([currentGPSData.lat, currentGPSData.lon], { icon: gliderIcon }).addTo(map);
      pathLayer = L.layerGroup().addTo(map);
      addLogMessage('Map initialized');
    }

    // Í≤ΩÎ°ú ÏÉùÏÑ±/Îç∞Î™® (ÏÉùÎûµ ÏóÜÏù¥ Í∏∞Ï°¥Í≥º ÎèôÏùº)
    function generatePath(type){
      const cLat=37.5665,cLon=126.9780,r=0.01;
      if(type==='circle'){ const pts=[]; for(let i=0;i<=360;i+=10){const a=i*Math.PI/180;pts.push([cLat+r*Math.cos(a), cLon+r*Math.sin(a)])} return pts;}
      if(type==='straight'){ const pts=[]; for(let i=0;i<=100;i+=2){const lat=cLat+r*(i-50)/50; const lon=cLon+r*Math.sin(i*0.1)*0.5; pts.push([lat,lon])} return pts;}
      if(type==='zigzag'){ const pts=[]; for(let i=0;i<=100;i+=2){const lat=cLat+r*(i-50)/50; const lon=cLon+r*Math.sin(i*0.5)*0.3; pts.push([lat,lon])} return pts;}
      if(type==='spiral'){ const pts=[]; for(let i=0;i<=720;i+=10){const a=i*Math.PI/180; const rr=r*(i/720); pts.push([cLat+rr*Math.cos(a), cLon+rr*Math.sin(a)])} return pts;}
      return [];
    }
    function startGPSDemo(){
      const sel=document.getElementById('gps-path').value;
      if(sel==='none'){ addLogMessage('Please select a GPS path type'); return; }
      currentPath = generatePath(sel); if(!currentPath.length) return;
      pathIndex=0; gpsDemoActive=true; pathLayer.clearLayers();
      L.polyline(currentPath, { color:'#3498db', weight:3 }).addTo(pathLayer);
      gpsDemoInterval=setInterval(()=>{
        if(pathIndex<currentPath.length){
          const [lat,lon]=currentPath[pathIndex];
          currentGPSData.lat=lat; currentGPSData.lon=lon;
          currentGPSData.speed=5+Math.random()*3; currentGPSData.heading=Math.random()*360;
          gliderMarker.setLatLng([lat,lon]); updateGPSDisplay(); pathIndex++;
        }else{ stopGPSDemo(); }
      },200);
      addLogMessage(`GPS demo started with ${sel} path`);
    }
    function stopGPSDemo(){ if(gpsDemoInterval){ clearInterval(gpsDemoInterval); gpsDemoInterval=null; } gpsDemoActive=false; addLogMessage('GPS demo stopped'); }
    function changeGPSPath(val){ if(gpsDemoActive) stopGPSDemo(); if(val!=='none'){ currentPath=generatePath(val); pathLayer.clearLayers(); L.polyline(currentPath,{color:'#3498db',weight:3}).addTo(pathLayer); addLogMessage(`GPS path changed to: ${val}`); } }
    function updateGPSDisplay(){ document.getElementById('gps-lat').textContent=currentGPSData.lat.toFixed(6); document.getElementById('gps-lon').textContent=currentGPSData.lon.toFixed(6); document.getElementById('gps-speed').textContent=currentGPSData.speed.toFixed(1); document.getElementById('gps-heading').textContent=Math.round(currentGPSData.heading); }

    // ===== Í∏ÄÎùºÏù¥Îçî Î™®Îç∏ =====
    function createGlider(){
      if(glider) scene.remove(glider);
      const g = new THREE.Group();
      const body = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.36,3.0,8), new THREE.MeshPhongMaterial({color:0x2c3e50,shininess:120,wireframe:wireframeMode}));
      body.rotation.z = Math.PI/2; body.castShadow=true; g.add(body);
      const wing = new THREE.Mesh(new THREE.BoxGeometry(2.25,0.15,0.45), new THREE.MeshPhongMaterial({color:0x34495e,shininess:120,wireframe:wireframeMode}));
      wing.castShadow=true; g.add(wing);
      const tail = new THREE.Mesh(new THREE.BoxGeometry(0.9,0.15,0.3), new THREE.MeshPhongMaterial({color:0x34495e,shininess:120,wireframe:wireframeMode}));
      tail.position.set(-1.05,0,0); tail.castShadow=true; g.add(tail);
      const rudder = new THREE.Mesh(new THREE.BoxGeometry(0.075,1.2,0.15), new THREE.MeshPhongMaterial({color:0x3498db,shininess:120,wireframe:wireframeMode}));
      rudder.position.set(-1.35,0,0); rudder.castShadow=true; g.add(rudder);
      const nose = new THREE.Mesh(new THREE.ConeGeometry(0.3,0.75,8), new THREE.MeshPhongMaterial({color:0x3498db,shininess:120,wireframe:wireframeMode}));
      nose.position.set(1.8,0,0); nose.rotation.z = -Math.PI/2; nose.castShadow=true; g.add(nose);
      const sensor = new THREE.Mesh(new THREE.SphereGeometry(0.12,8,6), new THREE.MeshPhongMaterial({color:0xe74c3c,emissive:0x220000,wireframe:wireframeMode}));
      sensor.position.set(0,0.375,0); g.add(sensor);
      glider = g; scene.add(glider);
      if(axesVisible){ const ax = new THREE.AxesHelper(1.5); ax.name='axes'; scene.add(ax); }
    }

    // ===== Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ =====
    function animate(){
      animationId = requestAnimationFrame(animate);
      // ÏãúÍ∞ÑÍ∏∞Î∞ò slerp
      if(glider){
        const dt = clock.getDelta();
        const tau = 0.08; // ÏùëÎãµ ÏãúÍ∞Ñ(Ï¥à)
        const alpha = 1 - Math.exp(-dt / tau);
        glider.quaternion.slerp(targetQuat, alpha);
      }
      renderer.render(scene, camera);
    }

    // ===== ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ =====
    // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅÏùÑ ÏúÑÌïú Î≥ÄÏàòÎì§
    let sensorHistory = {
      accX: [], accY: [], accZ: [],
      gyroX: [], gyroY: [], gyroZ: [],
      temperature: [], pitch: [], roll: [], yaw: []
    };
    const HISTORY_SIZE = 5; // ÏµúÍ∑º 5Í∞ú Í∞íÏúºÎ°ú ÌèâÍ∑†
    const MAX_CHANGE_RATE = {
      acc: 2.0,    // Í∞ÄÏÜçÎèÑ ÏµúÎåÄ Î≥ÄÌôîÏú®
      gyro: 50.0,  // ÏûêÏù¥Î°ú ÏµúÎåÄ Î≥ÄÌôîÏú®
      temp: 1.0,   // Ïò®ÎèÑ ÏµúÎåÄ Î≥ÄÌôîÏú®
      pitch: 10.0  // ÌîºÏπò ÏµúÎåÄ Î≥ÄÌôîÏú®
    };

    function smoothValue(current, history, maxChange) {
      if (history.length === 0) return current;
      
      const lastValue = history[history.length - 1];
      const change = Math.abs(current - lastValue);
      
      // Í∏âÍ≤©Ìïú Î≥ÄÌôîÍ∞Ä Í∞êÏßÄÎêòÎ©¥ Ï†úÌïú
      if (change > maxChange) {
        return lastValue + Math.sign(current - lastValue) * maxChange;
      }
      return current;
    }

    function updateSensorData(data){
      // Ïà´Ïûê ÌïÑÎìú ÏïàÏ†Ñ Ï≤òÎ¶¨
      function n(v, d=0){ return (typeof v === 'number' && isFinite(v)) ? v : d; }
      
      // ÌòÑÏû¨ Í∞íÎì§
      const rawAccX = n(data.accX);
      const rawAccY = n(data.accY);
      const rawAccZ = n(data.accZ);
      const rawGyroX = n(data.gyroX);
      const rawGyroY = n(data.gyroY);
      const rawGyroZ = n(data.gyroZ);
      const rawTemp = n(data.temperature, 25.0);
      const rawPitch = n(data.pitch);
      
      // Î∂ÄÎìúÎü¨Ïö¥ Í∞í Í≥ÑÏÇ∞
      const smoothAccX = smoothValue(rawAccX, sensorHistory.accX, MAX_CHANGE_RATE.acc);
      const smoothAccY = smoothValue(rawAccY, sensorHistory.accY, MAX_CHANGE_RATE.acc);
      const smoothAccZ = smoothValue(rawAccZ, sensorHistory.accZ, MAX_CHANGE_RATE.acc);
      const smoothGyroX = smoothValue(rawGyroX, sensorHistory.gyroX, MAX_CHANGE_RATE.gyro);
      const smoothGyroY = smoothValue(rawGyroY, sensorHistory.gyroY, MAX_CHANGE_RATE.gyro);
      const smoothGyroZ = smoothValue(rawGyroZ, sensorHistory.gyroZ, MAX_CHANGE_RATE.gyro);
      const smoothTemp = smoothValue(rawTemp, sensorHistory.temperature, MAX_CHANGE_RATE.temp);
      const smoothPitch = smoothValue(rawPitch, sensorHistory.pitch, MAX_CHANGE_RATE.pitch);
      
      // ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
      sensorHistory.accX.push(smoothAccX);
      sensorHistory.accY.push(smoothAccY);
      sensorHistory.accZ.push(smoothAccZ);
      sensorHistory.gyroX.push(smoothGyroX);
      sensorHistory.gyroY.push(smoothGyroY);
      sensorHistory.gyroZ.push(smoothGyroZ);
      sensorHistory.temperature.push(smoothTemp);
      sensorHistory.pitch.push(smoothPitch);
      
      // ÌûàÏä§ÌÜ†Î¶¨ ÌÅ¨Í∏∞ Ï†úÌïú
      Object.keys(sensorHistory).forEach(key => {
        if (sensorHistory[key].length > HISTORY_SIZE) {
          sensorHistory[key].shift();
        }
      });
      
      // UI ÏóÖÎç∞Ïù¥Ìä∏ (Î∂ÄÎìúÎü¨Ïö¥ Í∞í ÏÇ¨Ïö©)
      document.getElementById('acc-x').textContent = smoothAccX.toFixed(2);
      document.getElementById('acc-y').textContent = smoothAccY.toFixed(2);
      document.getElementById('acc-z').textContent = smoothAccZ.toFixed(2);
      document.getElementById('gyro-x').textContent = smoothGyroX.toFixed(2);
      document.getElementById('gyro-y').textContent = smoothGyroY.toFixed(2);
      document.getElementById('gyro-z').textContent = smoothGyroZ.toFixed(2);
      document.getElementById('temperature').textContent = smoothTemp.toFixed(1);
      document.getElementById('pitch').textContent = smoothPitch.toFixed(1);

      if(!glider) return;

      const src = ((data.source || '') + '').toUpperCase();
      const now = performance.now();

      // --- 1) DMP ÏøºÌÑ∞ÎãàÏñ∏ÎßåÏúºÎ°ú ÌöåÏ†Ñ(YPR Ìè¥Î∞±Í≥º ÎèôÏùºÌïú Ï∂ï Îß§Ìïë Ï†ÅÏö©) ---
      const hasQuat = ['qw','qx','qy','qz'].every(k => typeof data[k] === 'number');
      if (src.startsWith('DMP') && hasQuat) {
        // DMPÏóêÏÑú YPR Í∞íÏù¥ ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö© (YPR Ìè¥Î∞±Í≥º ÎèôÏùºÌïú Î°úÏßÅ)
        // YPR Í∞íÏù¥ ÏóÜÏúºÎ©¥ ÏøºÌÑ∞ÎãàÏñ∏ÏóêÏÑú Ï∂îÏ∂ú
        if (typeof data.yaw === 'number' && typeof data.roll === 'number' && typeof data.pitch === 'number') {
          // YPR Í∞í ÏÇ¨Ïö© (YPR Ìè¥Î∞±Í≥º ÎèôÏùºÌïú Îß§Ìïë)
          const roll  = deg2rad(smoothValue(n(data.roll), sensorHistory.roll || [], MAX_CHANGE_RATE.pitch));
          const pitch = deg2rad(smoothValue(n(data.pitch), sensorHistory.pitch, MAX_CHANGE_RATE.pitch));
          const yaw   = deg2rad(smoothValue(n(data.yaw), sensorHistory.yaw || [], MAX_CHANGE_RATE.pitch));
          // Yaw(X) ‚Üí Roll(Y) ‚Üí Pitch(Z) - yawÏôÄ roll, rollÍ≥º pitchÍ∞Ä ÍµêÌôòÎê®
          const euler = new THREE.Euler(yaw, roll, pitch, 'XYZ');
          const qMapped = new THREE.Quaternion().setFromEuler(euler);
          
          // ÏøºÌÑ∞ÎãàÏñ∏ Î∂ÄÎìúÎü¨Ïö¥ Î≥¥Í∞ÑÏùÑ ÏúÑÌïú ÌïÑÌÑ∞ÎßÅ
          if (targetQuat.length() > 0) {
            const dot = Math.abs(targetQuat.dot(qMapped));
            if (dot < 0.5) {
              targetQuat.slerp(qMapped, 0.1);
            } else {
              targetQuat.copy(qMapped);
            }
          } else {
            targetQuat.copy(qMapped);
          }
        } else {
          // YPR Í∞íÏù¥ ÏóÜÏúºÎ©¥ ÏøºÌÑ∞ÎãàÏñ∏ÏóêÏÑú Ïò§ÏùºÎü¨Î°ú Î≥ÄÌôò
          const qx = data.qx, qy = data.qy, qz = data.qz, qw = data.qw;
          const q = new THREE.Quaternion(qx, qy, qz, qw);
          q.normalize();
          
          // ÏøºÌÑ∞ÎãàÏñ∏ÏùÑ Ïò§ÏùºÎü¨ Í∞ÅÏúºÎ°ú Î≥ÄÌôò (ÏõêÎ≥∏ ÏàúÏÑú: XYZ)
          const eulerOriginal = new THREE.Euler().setFromQuaternion(q, 'XYZ');
          
          // YPR Ìè¥Î∞±Í≥º ÎèôÏùºÌïú Îß§Ìïë: yaw(X), roll(Y), pitch(Z)
          // ÏõêÎ≥∏ Ïò§ÏùºÎü¨ÏóêÏÑú: X=roll, Y=pitch, Z=yaw (ÏùºÎ∞òÏ†ÅÏù∏ Ìï≠Í≥µÍ∏∞ Ï¢åÌëúÍ≥Ñ)
          // Ïû¨Îß§Ìïë: yaw‚ÜíX, roll‚ÜíY, pitch‚ÜíZ
          const yaw = eulerOriginal.z;   // ÏõêÎ≥∏ ZÏ∂ï (yaw)
          const roll = eulerOriginal.x;  // ÏõêÎ≥∏ XÏ∂ï (roll)
          const pitch = eulerOriginal.y; // ÏõêÎ≥∏ YÏ∂ï (pitch)
          
          // Ïû¨Îß§ÌïëÎêú Ïò§ÏùºÎü¨ Í∞ÅÏúºÎ°ú ÏøºÌÑ∞ÎãàÏñ∏ ÏÉùÏÑ±
          const eulerRemapped = new THREE.Euler(yaw, roll, pitch, 'XYZ');
          const qMapped = new THREE.Quaternion().setFromEuler(eulerRemapped);
          
          // ÏøºÌÑ∞ÎãàÏñ∏ Î∂ÄÎìúÎü¨Ïö¥ Î≥¥Í∞ÑÏùÑ ÏúÑÌïú ÌïÑÌÑ∞ÎßÅ
          if (targetQuat.length() > 0) {
            const dot = Math.abs(targetQuat.dot(qMapped));
            if (dot < 0.5) {
              targetQuat.slerp(qMapped, 0.1);
            } else {
              targetQuat.copy(qMapped);
            }
          } else {
            targetQuat.copy(qMapped);
          }
        }
        lastDmpAt = now;
        return;
      }

      // --- 2) DMPÍ∞Ä ÏóÜÍ±∞ÎÇò(Ï¥àÍ∏∞) Ïû•ÏãúÍ∞Ñ ÎÅäÍ∏∞Î©¥ YPRÎ°ú Ìè¥Î∞±(>300ms) ---
      if (now - lastDmpAt > 300) {
        const roll  = deg2rad(smoothValue(n(data.roll), sensorHistory.roll || [], MAX_CHANGE_RATE.pitch));
        const pitch = deg2rad(smoothValue(n(data.pitch), sensorHistory.pitch, MAX_CHANGE_RATE.pitch));
        const yaw   = deg2rad(smoothValue(n(data.yaw), sensorHistory.yaw || [], MAX_CHANGE_RATE.pitch));
        // Yaw(X) ‚Üí Roll(Y) ‚Üí Pitch(Z) - yawÏôÄ roll, rollÍ≥º pitchÍ∞Ä ÍµêÌôòÎê®
        const euler = new THREE.Euler(yaw, roll, pitch, 'XYZ');
        const newQuat = new THREE.Quaternion().setFromEuler(euler);
        
        // YPRÏóêÎèÑ Î∂ÄÎìúÎü¨Ïö¥ Î≥¥Í∞Ñ Ï†ÅÏö©
        if (targetQuat.length() > 0) {
          const dot = Math.abs(targetQuat.dot(newQuat));
          if (dot < 0.5) {
            targetQuat.slerp(newQuat, 0.1);
          } else {
            targetQuat.copy(newQuat);
          }
        } else {
          targetQuat.copy(newQuat);
        }
      }
      // Í∑∏ Ïô∏(ÏµúÍ∑º DMP Ïú†ÏßÄ Ï§ë)ÏóêÎäî Ìè¥Î∞± ÌîÑÎ†àÏûÑÏùò ÌöåÏ†ÑÍ∞íÏùÄ Î¨¥ÏãúÌïòÏó¨ ÌùîÎì§Î¶º Ï†úÍ±∞
    }

    // ===== ÏãúÎÆ¨/ÌÜ†Í∏Ä/Î°úÍ∑∏ =====
    function simulateMovement(){
      if (isSimulating) return;
      isSimulating = true;
      let t=0;
      simulationInterval = setInterval(()=>{
        t+=0.1;
        const mock={
          accX: Math.sin(t)*2, accY: Math.cos(t*0.7)*1.5, accZ: Math.sin(t*0.5)*0.5+9.8,
          gyroX: Math.sin(t*1.2)*50, gyroY: Math.cos(t*0.8)*30, gyroZ: Math.sin(t*0.6)*20,
          temperature: 25 + Math.sin(t*0.1)*2, pitch: Math.sin(t*0.5)*15, source:'SIM'
        };
        updateSensorData(mock);
        addLogMessage(`Simulation data: ACC(${mock.accX.toFixed(1)}, ${mock.accY.toFixed(1)}, ${mock.accZ.toFixed(1)})`);
      },100);
      addLogMessage('Simulation started');
    }
    function stopSimulation(){ if(simulationInterval){ clearInterval(simulationInterval); simulationInterval=null; } isSimulating=false; addLogMessage('Simulation stopped'); }
    function resetGlider(){
      if(glider){ glider.rotation.set(0,0,0); glider.position.set(0,0,0); glider.quaternion.identity(); }
      
      // ÏÑºÏÑú ÌûàÏä§ÌÜ†Î¶¨ Ï¥àÍ∏∞Ìôî
      Object.keys(sensorHistory).forEach(key => {
        sensorHistory[key] = [];
      });
      
      // ÌÉÄÍ≤ü ÏøºÌÑ∞ÎãàÏñ∏ Ï¥àÍ∏∞Ìôî
      targetQuat.identity();
      
      updateSensorData({accX:0,accY:0,accZ:9.8,gyroX:0,gyroY:0,gyroZ:0,temperature:25.0,pitch:0.0, source:'RESET'});
      addLogMessage('Glider reset to initial position');
    }
    function toggleWireframe(){
      wireframeMode=!wireframeMode;
      if(glider){ glider.traverse(c=>{ if(c.isMesh && c.material) c.material.wireframe = wireframeMode; }); }
      addLogMessage(`Wireframe mode: ${wireframeMode?'ON':'OFF'}`);
    }
    function toggleAxes(){
      axesVisible=!axesVisible;
      const ax = scene.getObjectByName('axes');
      if(ax) scene.remove(ax);
      if(axesVisible){ const a = new THREE.AxesHelper(2); a.name='axes'; scene.add(a); }
      addLogMessage(`Coordinate axes: ${axesVisible?'ON':'OFF'}`);
    }
    function addLogMessage(msg){
      const lc = document.getElementById('log-console'); const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; lc.appendChild(p); lc.scrollTop = lc.scrollHeight;
    }
    function updateConnectionStatus(status){
      const as = document.getElementById('arduino-status'), at = document.getElementById('arduino-text');
      const cs = document.getElementById('camera-status'), ct = document.getElementById('camera-text');
      const cdi = document.getElementById('camera-device-info');
      
      if(status.arduino_connected){ 
        as.className='status-indicator status-connected'; 
        at.textContent=`Connected (${status.arduino_port})`; 
      } else { 
        as.className='status-indicator status-disconnected'; 
        at.textContent='Disconnected'; 
      }
      
      if(status.camera_connected){ 
        cs.className='status-indicator status-connected'; 
        ct.textContent='Connected';
        if(status.camera_device && status.camera_device !== 'Not available') {
          cdi.textContent = `Device: ${status.camera_device}`;
        } else {
          cdi.textContent = '';
        }
      } else { 
        cs.className='status-indicator status-disconnected'; 
        ct.textContent='Disconnected';
        cdi.textContent = 'No camera available';
      }
    }

    // ===== Socket.IO Ïó∞Í≤∞ =====
    document.addEventListener('DOMContentLoaded', ()=>{
      const socket = io.connect(window.location.origin);
      const commandInput = document.getElementById('command-input');

      initGlider(); initCamera(); initMap();

      socket.on('connect', ()=> addLogMessage('Connected to server'));
      socket.on('serial_log', msg => addLogMessage(msg.data));
      let lastSensorLogTs=0;
      socket.on('sensor_update', data=>{
        updateSensorData(data); // 3D Î™®Îç∏ÏùÄ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const now = Date.now();
        // Î°úÍ∑∏Îßå 5Ï¥àÎßàÎã§ Ï∂úÎ†•
        if(now - lastSensorLogTs > 5000){
          addLogMessage(`Sensor data: pitch=${(+data.pitch||0).toFixed(1)}¬∞ yaw=${(+data.yaw||0).toFixed(1)}¬∞ roll=${(+data.roll||0).toFixed(1)}¬∞`);
          lastSensorLogTs = now;
        }
      });
      socket.on('connection_status', status=>{
        updateConnectionStatus(status);
        addLogMessage(`Connection status updated: Arduino(${status.arduino_connected?'Connected':'Disconnected'}), Camera(${status.camera_connected?'Connected':'Disconnected'})`);
      });
      socket.on('port_scan_results', data=>{
        addLogMessage(`Port scan completed: ${data.message}`);
        data.ports.forEach(port=>{
          if(port.available) {
            addLogMessage(`  Found Arduino on ${port.port}: ${port.response}`);
          }
        });
      });
      socket.on('recording_status', status=>{
        function setRecordingInfo(text, active){
          const el = document.getElementById('recording-info');
          el.textContent = `Recording: ${active ? ('ON' + (text ? ` - ${text}` : '')) : 'OFF'}`;
          el.style.color = active ? '#e74c3c' : '#666';
        }
        if(status && status.recording){
          setRecordingInfo(status.filename || '', true);
        } else {
          setRecordingInfo('', false);
        }
      });

      window.sendCommand = ()=>{ const c = commandInput.value.trim(); if(c){ socket.emit('control_event',{command:c}); addLogMessage(`Command sent: ${c}`); commandInput.value=''; } };
      window.simulateMovement = simulateMovement;
      window.stopSimulation = stopSimulation;
      window.resetGlider = resetGlider;
      window.toggleWireframe = toggleWireframe;
      window.toggleAxes = toggleAxes;
      window.startGPSDemo = startGPSDemo;
      window.stopGPSDemo = stopGPSDemo;
      window.changeGPSPath = changeGPSPath;
      window.reconnectDevices = ()=>{ socket.emit('request_reconnect'); addLogMessage('Reconnection requested'); };
      window.scanPorts = ()=>{ socket.emit('request_port_scan'); addLogMessage('Port scan requested'); };
      // ===== Recording / Video List =====
      window.startRecording = ()=>{ socket.emit('start_recording'); addLogMessage('Recording start requested'); };
      window.stopRecording = ()=>{ socket.emit('stop_recording'); addLogMessage('Recording stop requested'); };
      function renderVideoList(videos){
        const container = document.getElementById('saved-videos');
        container.innerHTML = '';
        if(!videos || !videos.length){
          const empty = document.createElement('div');
          empty.style.fontSize = '.9em'; empty.style.color = '#888';
          empty.textContent = 'No videos';
          container.appendChild(empty);
          return;
        }
        videos.forEach(v=>{
          const item = document.createElement('div');
          item.style.display='flex';
          item.style.justifyContent='space-between';
          item.style.alignItems='center';
          item.style.border='1px solid #e1e8ed';
          item.style.borderRadius='6px';
          item.style.padding='6px 8px';
          item.style.background='#fafbfc';
          const left = document.createElement('div');
          left.textContent = v.name;
          left.style.cursor = 'pointer';
          left.onclick = ()=> playVideo(v.name);
          const right = document.createElement('div');
          right.style.fontSize = '.8em'; right.style.color = '#666';
          const sizeMB = (Number(v.size_bytes||0)/1024/1024).toFixed(1);
          right.textContent = `${sizeMB} MB`;
          item.appendChild(left); item.appendChild(right);
          container.appendChild(item);
        });
      }
      async function refreshVideoList(){
        try{
          const res = await fetch('/videos', { cache: 'no-store' });
          const data = await res.json();
          renderVideoList(data.videos || []);
          addLogMessage('Video list refreshed');
        }catch(e){
          addLogMessage('Failed to load videos');
        }
      }
      window.refreshVideoList = refreshVideoList;
      window.playVideo = (name)=>{
        const player = document.getElementById('video-player');
        player.src = `/videos/${encodeURIComponent(name)}?t=${Date.now()}`;
        player.play().catch(()=>{});
        addLogMessage(`Playing video: ${name}`);
      };
      window.startPreMission = ()=>{
        const mission = {
          pattern: "sawtooth_pitch",
          pitch_step: 200,
          segment_time: 2.0,
          start_delay: 20.0,
          repeat: 5
        };
        socket.emit('start_mission', mission);
        addLogMessage('Pre-mission sawtooth_pitch started');
      };
      // ===== Mission UI/Logic =====
      function updateMissionUI(){
        const p = document.getElementById('mission-pattern').value;
        document.getElementById('params-sawtooth').style.display = (p==='sawtooth_pitch') ? '' : 'none';
        document.getElementById('params-pitch-test').style.display = (p==='pitch_only_test') ? '' : 'none';
        document.getElementById('params-small-box').style.display = (p==='small_box_turn') ? '' : 'none';
        document.getElementById('params-custom').style.display = (p==='custom_segments') ? '' : 'none';
      }
      function addCustomSegmentRow(m1=0, m2=0, wait=1.0){
        const tbody = document.querySelector('#custom-segments-table tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:4px;"><input type="number" value="${m1}" step="1" style="width:100%;" /></td>
          <td style="padding:4px;"><input type="number" value="${m2}" step="1" style="width:100%;" /></td>
          <td style="padding:4px;"><input type="number" value="${wait}" step="0.1" style="width:100%;" /></td>
          <td style="padding:4px;"><button class="test-btn" style="background:#e74c3c;" onclick="this.closest('tr').remove()">Remove</button></td>
        `;
        tbody.appendChild(tr);
      }
      function readCustomSegments(){
        const rows = Array.from(document.querySelectorAll('#custom-segments-table tbody tr'));
        return rows.map(r=>{
          const inputs = r.querySelectorAll('input');
          return {
            m1: Number(inputs[0].value||0),
            m2: Number(inputs[1].value||0),
            wait: Number(inputs[2].value||0)
          };
        }).filter(s=>Number.isFinite(s.m1) && Number.isFinite(s.m2) && Number.isFinite(s.wait));
      }
      window.startMission = ()=>{
        const pattern = document.getElementById('mission-pattern').value;
        if(pattern==='sawtooth_pitch'){
          const mission = {
            pattern: 'sawtooth_pitch',
            params: {
              pitch_step: Number(document.getElementById('pitch-step').value),
              segment_time: Number(document.getElementById('segment-time').value),
              start_delay: Number(document.getElementById('start-delay').value),
              repeat: Number(document.getElementById('repeat').value)
            }
          };
          socket.emit('start_mission', mission);
          addLogMessage('Mission requested: sawtooth_pitch');
          return;
        }
        if(pattern==='pitch_only_test'){
          const mission = {
            pattern: 'pitch_only_test',
            params: {
              pitch_step: Number(document.getElementById('pt-pitch-step').value),
              segment_time: Number(document.getElementById('pt-segment-time').value),
              start_delay: Number(document.getElementById('pt-start-delay').value)
            }
          };
          socket.emit('start_mission', mission);
          addLogMessage('Mission requested: pitch_only_test');
          return;
        }
        if(pattern==='small_box_turn'){
          const mission = {
            pattern: 'small_box_turn',
            params: {
              pitch_step: Number(document.getElementById('sb-pitch-step').value),
              turn_step: Number(document.getElementById('sb-turn-step').value),
              segment_time_forward: Number(document.getElementById('sb-seg-forward').value),
              segment_time_turn: Number(document.getElementById('sb-seg-turn').value),
              start_delay: Number(document.getElementById('sb-start-delay').value),
              repeat: Number(document.getElementById('sb-repeat').value)
            }
          };
          socket.emit('start_mission', mission);
          addLogMessage('Mission requested: small_box_turn');
          return;
        }
        if(pattern==='custom_segments'){
          const mission = {
            pattern: 'custom_segments',
            segments: readCustomSegments(),
            start_delay: Number(document.getElementById('custom-start-delay').value)
          };
          socket.emit('start_mission', mission);
          addLogMessage(`Mission requested: custom_segments (${mission.segments.length} segments)`);
          return;
        }
      };
      // Ï¥àÍ∏∞Ìôî
      document.getElementById('mission-pattern').addEventListener('change', updateMissionUI);
      updateMissionUI();
      // Í∏∞Î≥∏ Ïª§Ïä§ÌÖÄ ÏÑ∏Í∑∏Î®ºÌä∏ 2Ï§Ñ(200,0 / -200,0)
      addCustomSegmentRow(200, 0, 2.0);
      addCustomSegmentRow(-200, 0, 2.0);
      refreshVideoList();

      commandInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendCommand(); });

      window.addEventListener('resize', ()=>{
        const container = document.getElementById('glider-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        if(map){ setTimeout(()=> map.invalidateSize(), 100); }
      });
    });
  </script>
</body>
</html>
